<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>‰∏â 0 ¬∑ Catur + Leaderboard Ribuan</title>
    <!-- chessboard.js CSS -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/chessboard-js/1.0.0/chessboard-1.0.0.min.css">
    <!-- PeerJS for WebRTC -->
    <script src="https://unpkg.com/peerjs@1.5.4/dist/peerjs.min.js"></script>
    <style>
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }
        body {
            background: linear-gradient(145deg, #0f1a24 0%, #0b131c 100%);
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            font-family: 'Segoe UI', Roboto, system-ui, sans-serif;
            margin: 0;
            padding: 8px;
            position: relative;
            overflow-x: hidden;
        }
        #particle-canvas {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 0;
            will-change: transform;
        }
        .game-container {
            background: rgba(30, 40, 50, 0.85);
            padding: 20px 18px 24px 18px;
            border-radius: 36px;
            box-shadow: 0 15px 25px -5px rgba(0,0,0,0.7);
            border: 1px solid rgba(255,255,255,0.15);
            max-width: 950px;
            width: fit-content;
            position: relative;
            z-index: 1;
        }
        .header {
            display: flex;
            flex-wrap: wrap;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 18px;
            padding: 0 5px;
            color: #f0ead2;
            text-shadow: 0 1px 3px black;
            gap: 10px;
        }
        .left-symbol {
            font-size: 2.2rem;
            font-weight: 400;
            letter-spacing: 4px;
            background: rgba(38, 50, 63, 0.8);
            padding: 8px 22px;
            border-radius: 60px;
            box-shadow: inset 0 2px 5px rgba(0,0,0,0.3), 0 5px 0 rgba(27,37,48,0.5);
            border-bottom: 2px solid rgba(127,155,181,0.6);
            line-height: 1;
            color: #f2e9d0;
            backdrop-filter: blur(4px);
            cursor: pointer;
        }
        .score-box {
            background: rgba(35, 45, 55, 0.95);
            padding: 6px 18px;
            border-radius: 40px;
            box-shadow: inset 0 1px 3px rgba(0,0,0,0.5), 0 4px 0 rgba(20,30,40,0.8);
            border-bottom: 2px solid rgba(100,130,150,0.5);
            font-size: 1.3rem;
            font-weight: 600;
            color: #f9e7b3;
            display: flex;
            gap: 20px;
        }
        .score-item {
            display: flex;
            align-items: center;
            gap: 4px;
        }
        .score-badge {
            background: rgba(20, 30, 40, 0.95);
            border-radius: 30px;
            padding: 2px 12px;
            font-size: 1.2rem;
            color: #ecd79b;
            border: 1px solid rgba(140,170,190,0.5);
        }
        .turn-indicators {
            display: flex;
            gap: 12px;
            background: rgba(35, 45, 55, 0.95);
            padding: 6px 16px;
            border-radius: 40px;
            box-shadow: inset 0 1px 3px rgba(0,0,0,0.5), 0 4px 0 rgba(20,30,40,0.8);
            border-bottom: 2px solid rgba(100,130,150,0.5);
        }
        .turn-indicator {
            font-size: 1rem;
            font-weight: 500;
            padding: 4px 12px;
            border-radius: 30px;
            background: rgba(50, 65, 80, 0.95);
            color: #b6cdde;
            box-shadow: 0 2px 0 rgba(30,40,50,0.5);
            cursor: default;
            border: 1px solid rgba(100,130,150,0.4);
        }
        .turn-indicator.active {
            background: #ecd79b;
            color: #1d2f3f;
            font-weight: 600;
            box-shadow: 0 3px 0 #a08441;
            border-color: #fde5b1;
            transform: translateY(-1px);
        }
        .hamburger {
            display: flex;
            flex-direction: column;
            justify-content: space-around;
            width: 30px;
            height: 30px;
            background: rgba(40, 50, 60, 0.95);
            border: 1px solid rgba(255,255,255,0.2);
            border-radius: 8px;
            padding: 5px 4px;
            cursor: pointer;
            transition: 0.1s;
            margin-left: 5px;
        }
        .hamburger:hover {
            background: rgba(60, 75, 90, 0.95);
        }
        .hamburger-line {
            width: 100%;
            height: 3px;
            background: #f0ead2;
            border-radius: 3px;
        }
        .hamburger-dropdown {
            position: absolute;
            top: 80px;
            right: 25px;
            background: rgba(30, 40, 50, 0.98);
            border-radius: 14px;
            padding: 10px;
            display: none;
            flex-direction: column;
            border: 1px solid rgba(255,255,255,0.2);
            box-shadow: 0 8px 16px rgba(0,0,0,0.6);
            z-index: 200;
            min-width: 140px;
            gap: 5px;
        }
        .hamburger-dropdown.show {
            display: flex;
        }
        .hamburger-dropdown button {
            background: #2e4e5e;
            border: none;
            color: white;
            padding: 8px 14px;
            border-radius: 24px;
            cursor: pointer;
            font-weight: 600;
            border-bottom: 2px solid #1a2f3a;
            font-size: 0.95rem;
            text-align: left;
        }
        .hamburger-dropdown button:active {
            transform: translateY(2px);
            border-bottom-width: 1px;
        }
        .mode-selector {
            display: flex;
            justify-content: center;
            gap: 10px;
            margin: 12px 0 8px;
            flex-wrap: wrap;
        }
        .mode-btn {
            background: rgba(40, 55, 70, 0.95);
            border: none;
            border-bottom: 3px solid rgba(20,30,40,0.9);
            color: #dbd1b2;
            font-size: 1.1rem;
            font-weight: 600;
            padding: 8px 20px;
            border-radius: 36px;
            cursor: pointer;
            box-shadow: 0 4px 0 rgba(10,20,30,0.7);
            transition: 0.05s linear;
            border: 1px solid rgba(80,110,130,0.5);
            flex: 0 1 auto;
        }
        .mode-btn.active {
            background: #ecd79b;
            color: #1f333f;
            border-bottom-color: #a58542;
            transform: translateY(2px);
            box-shadow: 0 2px 0 #0e1a22;
        }

        /* Level selector */
        .level-selector {
            display: flex;
            justify-content: center;
            gap: 8px;
            margin: 8px 0;
            flex-wrap: wrap;
        }
        .level-btn {
            background: rgba(30, 45, 60, 0.95);
            border: none;
            border-bottom: 2px solid #1a2f3a;
            color: #ccc;
            font-size: 0.9rem;
            font-weight: 600;
            padding: 6px 16px;
            border-radius: 30px;
            cursor: pointer;
            box-shadow: 0 3px 0 #0e1a22;
            transition: 0.05s linear;
        }
        .level-btn.active {
            background: #d4b87a;
            color: #1f333f;
            border-bottom-color: #8b6f42;
            transform: translateY(2px);
            box-shadow: 0 1px 0 #0e1a22;
        }
        .vip-panel {
            display: flex;
            justify-content: center;
            gap: 8px;
            margin: 8px 0;
            align-items: center;
            flex-wrap: wrap;
        }
        .vip-input {
            background: rgba(15, 25, 35, 0.95);
            border: 1px solid rgba(255,215,0,0.5);
            color: #fff;
            padding: 6px 12px;
            border-radius: 30px;
            font-size: 0.9rem;
            outline: none;
            width: 200px;
        }
        .vip-btn {
            background: #c9a04b;
            border: none;
            border-bottom: 2px solid #7e5f2e;
            color: black;
            padding: 6px 16px;
            border-radius: 30px;
            font-weight: bold;
            cursor: pointer;
        }

        /* Panel online */
        .online-panel {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 8px;
            margin: 10px 0;
            background: rgba(30, 40, 50, 0.95);
            border-radius: 50px;
            padding: 12px 18px;
            border: 1px solid rgba(255,255,255,0.1);
        }
        .online-row {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
            justify-content: center;
            align-items: center;
        }
        .online-input {
            background: rgba(15, 25, 35, 0.95);
            border: 1px solid rgba(255,255,255,0.2);
            color: #fff;
            padding: 8px 16px;
            border-radius: 30px;
            font-size: 0.95rem;
            outline: none;
            min-width: 150px;
        }
        .online-input::placeholder {
            color: #a0b0c0;
        }
        .online-btn {
            background: #2e4e5e;
            border: none;
            border-bottom: 2px solid #1a2f3a;
            color: white;
            padding: 8px 18px;
            border-radius: 30px;
            font-weight: 600;
            cursor: pointer;
            box-shadow: 0 3px 0 #0e1a22;
        }
        .online-btn:active {
            transform: translateY(3px);
            border-bottom-width: 1px;
            box-shadow: 0 1px 0 #0e1a22;
        }
        .online-status {
            color: #b0e0ff;
            font-size: 1rem;
            text-shadow: 0 1px 2px black;
        }

        .board-wrapper {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            margin: 10px 0 15px 0;
            filter: drop-shadow(0 10px 8px #101820);
        }

        .led-strip {
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            gap: 5px 8px;
            margin: 6px 0;
            padding: 0 5px;
            pointer-events: none;
        }

        .led {
            width: 14px;
            height: 14px;
            border-radius: 50%;
            background: #ffaa00;
            box-shadow: 0 0 5px currentColor;
            animation: fade 2s infinite ease-in-out;
            flex-shrink: 0;
        }

        .led:nth-child(1) { background: #ff4d4d; animation-delay: 0.0s; }
        .led:nth-child(2) { background: #ffdb4d; animation-delay: 0.2s; }
        .led:nth-child(3) { background: #4dff4d; animation-delay: 0.4s; }
        .led:nth-child(4) { background: #4dffff; animation-delay: 0.6s; }
        .led:nth-child(5) { background: #4d4dff; animation-delay: 0.8s; }
        .led:nth-child(6) { background: #ff4dff; animation-delay: 1.0s; }
        .led:nth-child(7) { background: #ff884d; animation-delay: 0.3s; }
        .led:nth-child(8) { background: #88ff4d; animation-delay: 0.5s; }
        .led:nth-child(9) { background: #4dff88; animation-delay: 0.7s; }
        .led:nth-child(10) { background: #4d88ff; animation-delay: 0.9s; }
        .led:nth-child(11) { background: #ff4d88; animation-delay: 1.1s; }
        .led:nth-child(12) { background: #ffaa4d; animation-delay: 1.3s; }

        @keyframes fade {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.3; }
        }

        .board-row {
            display: flex;
            flex-direction: row;
            align-items: center;
            justify-content: center;
            gap: 8px;
            margin: 5px 0;
        }

        /* SEMBUNYIKAN SEMUA AVATAR DI SAMPING PAPAN */
        .online-players {
            display: none;
        }

        /* STYLE UNTUK ELEMEN BARU "SEMUA PLAYER ONLINE" */
        .online-all-players {
            text-align: center;
            margin: 15px 0 5px;
            width: 100%;
        }
        .online-toggle-btn {
            background: rgba(40, 55, 70, 0.95);
            border: none;
            border-bottom: 3px solid rgba(20,30,40,0.9);
            color: #dbd1b2;
            font-size: 1.1rem;
            font-weight: 600;
            padding: 8px 20px;
            border-radius: 36px;
            cursor: pointer;
            box-shadow: 0 4px 0 rgba(10,20,30,0.7);
            transition: 0.05s linear;
            border: 1px solid rgba(80,110,130,0.5);
        }
        .online-players-list {
            background: rgba(30, 40, 50, 0.95);
            border-radius: 20px;
            padding: 15px;
            margin-top: 10px;
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            gap: 10px;
            border: 1px solid rgba(255,255,255,0.1);
            max-height: 400px;
            overflow-y: auto;
        }
        .avatar-list-item {
            display: flex;
            align-items: center;
            gap: 6px;
            background: rgba(20, 30, 40, 0.8);
            padding: 3px 10px 3px 3px;
            border-radius: 30px;
            color: white;
            border: 1px solid rgba(255,255,255,0.2);
            font-size: 0.85rem;
        }
        .avatar-list-item img {
            width: 28px;
            height: 28px;
            border-radius: 50%;
            object-fit: cover;
            border: 2px solid rgba(255,215,0,0.3);
        }
        .dot-list {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            background: #4caf50;
            display: inline-block;
            margin-left: 4px;
        }
        .dot-list.offline {
            background: #9e9e9e;
        }

        #board {
            width: 440px;
            height: 440px;
            border-radius: 16px;
            overflow: hidden;
            border: 3px solid rgba(80, 100, 120, 0.9);
            box-shadow: inset 0 0 0 1px rgba(200,180,150,0.3), 0 6px 8px rgba(0,0,0,0.5);
            touch-action: none;
            -webkit-user-select: none;
            user-select: none;
        }

        .white-1e1d7 {
            background-color: rgba(230, 225, 200, 0.9) !important;
        }
        .black-3c85d {
            background-color: rgba(80, 120, 120, 0.9) !important;
        }

        .square-55d63 {
            touch-action: none;
            -webkit-user-select: none;
            user-select: none;
        }

        .footer {
            display: flex;
            justify-content: center;
            gap: 15px;
            margin-top: 16px;
            flex-wrap: wrap;
        }
        .action-btn {
            background: rgba(40, 60, 75, 0.95);
            border: none;
            border-bottom: 4px solid rgba(25,40,50,0.9);
            color: #fcf3dd;
            font-size: 1.2rem;
            font-weight: 600;
            padding: 8px 22px;
            border-radius: 50px;
            cursor: pointer;
            box-shadow: 0 5px 0 rgba(15,25,35,0.7);
            transition: 0.05s linear;
            text-transform: uppercase;
            border: 1px solid rgba(100,130,150,0.5);
        }
        .action-btn:active {
            transform: translateY(4px);
            border-bottom-width: 2px;
            box-shadow: 0 2px 0 #15222b;
        }
        .reset-score-btn {
            background: rgba(70, 60, 60, 0.95);
            border-bottom-color: rgba(40,35,35,0.9);
        }

        /* Leaderboard & Visitor */
        .leaderboard-section {
            margin-top: 20px;
            padding: 15px;
            background: rgba(35, 45, 55, 0.95);
            border-radius: 30px;
            border: 1px solid rgba(255,255,255,0.15);
            color: #f0ead2;
        }
        .leaderboard-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
            flex-wrap: wrap;
            gap: 10px;
        }
        .leaderboard-title {
            font-size: 1.4rem;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .visitor-count {
            background: rgba(20, 30, 40, 0.95);
            padding: 5px 15px;
            border-radius: 30px;
            font-size: 1rem;
            border: 1px solid rgba(255,215,0,0.3);
        }
        .leaderboard-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 10px;
            max-height: 400px;
            overflow-y: auto;
            display: block;
        }
        .leaderboard-table thead,
        .leaderboard-table tbody tr {
            display: table;
            width: 100%;
            table-layout: fixed;
        }
        .leaderboard-table tbody {
            display: block;
            max-height: 350px;
            overflow-y: auto;
        }
        .leaderboard-table th {
            text-align: left;
            padding: 8px 5px;
            color: #ecd79b;
            font-weight: 600;
            border-bottom: 2px solid rgba(255,255,255,0.2);
        }
        .leaderboard-table td {
            padding: 5px;
            border-bottom: 1px solid rgba(255,255,255,0.1);
        }
        .leaderboard-table tr:last-child td {
            border-bottom: none;
        }

        @media (max-width: 700px) {
            .board-row {
                flex-wrap: wrap;
            }
            #board {
                order: 1;
                width: 340px;
                height: 340px;
            }
            .game-container {
                max-width: 600px;
                padding: 15px;
            }
        }
        @media (max-width: 450px) {
            #board { width: 300px; height: 300px; }
            .led { width: 12px; height: 12px; }
            .turn-indicator { font-size: 0.8rem; padding: 3px 8px; }
            .score-box { font-size: 1rem; padding: 4px 12px; gap: 10px; }
            .mode-btn { font-size: 0.9rem; padding: 6px 14px; }
        }
    </style>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/chess.js/0.10.3/chess.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/chessboard-js/1.0.0/chessboard-1.0.0.min.js"></script>
</head>
<body>
    <canvas id="particle-canvas"></canvas>

    <div class="game-container">
        <div class="header">
            <div class="left-symbol">‰∏â 0</div>
            <div class="score-box">
                <div class="score-item">‚ö™ <span id="scoreWhite" class="score-badge">0</span></div>
                <div class="score-item">‚ö´ <span id="scoreBlack" class="score-badge">0</span></div>
            </div>
            <div class="turn-indicators">
                <span id="white-turn" class="turn-indicator active">1. White</span>
                <span id="black-turn" class="turn-indicator">2. Black</span>
            </div>
            <div class="hamburger" id="hamburgerBtn">
                <div class="hamburger-line"></div>
                <div class="hamburger-line"></div>
                <div class="hamburger-line"></div>
            </div>
        </div>

        <div class="hamburger-dropdown" id="hamburgerDropdown">
            <button id="fixLagBtn">Fix Lag: Off</button>
        </div>

        <div class="mode-selector">
            <button id="mode2p" class="mode-btn">üë• 2P</button>
            <button id="modeBot" class="mode-btn active">ü§ñ Bot</button>
            <button id="modeOnline" class="mode-btn">üåê Online</button>
        </div>

        <!-- Level Bot & VIP -->
        <div class="level-selector" id="levelSelector">
            <button id="levelEasy" class="level-btn active">Mudah</button>
            <button id="levelMedium" class="level-btn">Sedang</button>
            <button id="levelHard" class="level-btn">Sulit</button>
            <button id="levelExtrem" class="level-btn">üîí Extrem</button>
        </div>
        <div class="vip-panel" id="vipPanel" style="display: none;">
            <input type="password" id="vipKey" class="vip-input" placeholder="Kunci VIP Extrem">
            <button id="unlockVip" class="vip-btn">Unlock</button>
        </div>

        <div id="onlinePanel" class="online-panel" style="display: none;">
            <div class="online-row">
                <input type="text" id="nameInput" class="online-input" placeholder="Nama kamu" value="Player">
                <input type="text" id="peerIdInput" class="online-input" placeholder="ID lawan">
            </div>
            <div class="online-row">
                <button id="hostBtn" class="online-btn">üéÆ Host</button>
                <button id="joinBtn" class="online-btn">üîó Join</button>
            </div>
            <div class="online-row">
                <span id="onlineStatus" class="online-status">Status: Offline</span>
                <span id="myPeerId" class="online-status"></span>
            </div>
        </div>

        <div class="board-wrapper">
            <div class="led-strip">
                <div class="led"></div><div class="led"></div><div class="led"></div><div class="led"></div>
                <div class="led"></div><div class="led"></div><div class="led"></div><div class="led"></div>
                <div class="led"></div><div class="led"></div><div class="led"></div><div class="led"></div>
            </div>

            <div class="board-row">
                <!-- AVATAR KIRI 8 (DISEMBUNYIKAN OLEH CSS) - tapi kita tidak pakai, akan diganti dummy -->
                <div class="online-players left"></div>
                <div id="board"></div>
                <div class="online-players right"></div>
            </div>

            <!-- ELEMEN SEMUA PLAYER ONLINE (RIBUAN) -->
            <div class="online-all-players">
                <button class="online-toggle-btn">üë• Semua Player Online (500+)</button>
                <div class="online-players-list" style="display: none;"></div>
            </div>

            <div class="led-strip">
                <div class="led"></div><div class="led"></div><div class="led"></div><div class="led"></div>
                <div class="led"></div><div class="led"></div><div class="led"></div><div class="led"></div>
                <div class="led"></div><div class="led"></div><div class="led"></div><div class="led"></div>
            </div>
        </div>

        <div class="footer">
            <button class="action-btn" id="newGameBtn">‚Ü∫ New</button>
            <button class="action-btn reset-score-btn" id="resetScoreBtn">‚ü≤ Reset</button>
        </div>

        <!-- Leaderboard & Visitor Section (tanpa input nama dan reset) -->
        <div class="leaderboard-section">
            <div class="leaderboard-header">
                <div class="leaderboard-title">
                    üèÜ Leaderboard Global (1000+)
                    <span class="visitor-count" id="visitorCount">üë• 0</span>
                </div>
            </div>
            <table class="leaderboard-table" id="leaderboardTable">
                <thead>
                    <tr><th>Nama</th><th>Menang</th><th>Koin ü™ô</th></tr>
                </thead>
                <tbody id="leaderboardBody">
                    <tr><td colspan="3">Memuat...</td></tr>
                </tbody>
            </table>
        </div>
    </div>

    <script>
        // ==================== PARTIKEL RINGAN ====================
        const ParticleSystem = (function() {
            const canvas = document.getElementById('particle-canvas');
            const ctx = canvas.getContext('2d');
            let width, height;
            let particles = [];
            let animationFrame = null;
            let isRunning = false;

            function initParticles() {
                particles = [];
                const particleCount = 20;
                for (let i = 0; i < particleCount; i++) {
                    particles.push({
                        x: Math.random() * width,
                        y: Math.random() * height,
                        vx: (Math.random() - 0.5) * 0.3,
                        vy: (Math.random() - 0.5) * 0.15,
                        radius: Math.random() * 2 + 1,
                        color: `hsl(${Math.random() * 60 + 200}, 70%, 65%)`,
                        alpha: Math.random() * 0.5 + 0.2,
                        blinkSpeed: Math.random() * 0.02 + 0.01,
                        blinkPhase: Math.random() * Math.PI * 2
                    });
                }
            }

            function resizeCanvas() {
                width = window.innerWidth;
                height = window.innerHeight;
                canvas.width = width;
                canvas.height = height;
                if (isRunning) drawParticles();
            }

            function updateParticles() {
                for (let p of particles) {
                    p.x += p.vx;
                    p.y += p.vy;
                    if (p.x < 0) p.x = width;
                    if (p.x > width) p.x = 0;
                    if (p.y < 0) p.y = height;
                    if (p.y > height) p.y = 0;
                    p.alpha = 0.3 + 0.3 * Math.sin(Date.now() * p.blinkSpeed + p.blinkPhase);
                }
            }

            function drawParticles() {
                ctx.clearRect(0, 0, width, height);
                for (let p of particles) {
                    ctx.beginPath();
                    ctx.arc(p.x, p.y, p.radius, 0, Math.PI * 2);
                    ctx.fillStyle = p.color;
                    ctx.globalAlpha = p.alpha;
                    ctx.fill();
                }
                ctx.globalAlpha = 1.0;
            }

            function animate() {
                if (!isRunning) return;
                updateParticles();
                drawParticles();
                animationFrame = requestAnimationFrame(animate);
            }

            function start() {
                if (isRunning) return;
                isRunning = true;
                if (!particles.length) initParticles();
                animate();
            }

            function stop() {
                isRunning = false;
                if (animationFrame) {
                    cancelAnimationFrame(animationFrame);
                    animationFrame = null;
                }
                ctx.clearRect(0, 0, width, height);
            }

            window.addEventListener('resize', resizeCanvas);
            resizeCanvas();
            initParticles();
            start();

            return { start, stop };
        })();

        // ==================== LOGIKA CATUR ====================
        $(document).ready(function() {
            var game = new Chess();
            var pieceTheme = 'https://chessboardjs.com/img/chesspieces/wikipedia/{piece}.png';
            var gameMode = 'vsbot'; // default bot
            var scoreWhite = 0, scoreBlack = 0;
            var $scoreWhite = $('#scoreWhite'), $scoreBlack = $('#scoreBlack');
            var board;

            // ========== DEVICE ID dan UNLOCK EXTREM ==========
            var deviceId = localStorage.getItem('catur_deviceId');
            if (!deviceId) {
                deviceId = 'device_' + Math.random().toString(36).substring(2) + Date.now().toString(36);
                localStorage.setItem('catur_deviceId', deviceId);
            }
            var extremUnlocked = localStorage.getItem('catur_extremUnlocked') === 'true';
            var currentLevel = 'easy';

            // Online vars
            var peer = null, conn = null, myId = null, isHost = false, onlineConnected = false;
            var $onlineStatus = $('#onlineStatus'), $myPeerId = $('#myPeerId');
            var myName = '', opponentName = '';

            // Audio
            var audioCtx = null;
            function playMoveSound() {
                try {
                    if (!audioCtx) audioCtx = new (window.AudioContext || window.webkitAudioContext)();
                    if (audioCtx.state === 'suspended') {
                        audioCtx.resume().then(() => createMoveSound(audioCtx));
                    } else createMoveSound(audioCtx);
                } catch (e) { console.warn("Audio error"); }
            }
            function createMoveSound(ctx) {
                var osc = ctx.createOscillator();
                var gainNode = ctx.createGain();
                osc.type = 'sine';
                osc.frequency.value = 600;
                gainNode.gain.value = 0.8;
                osc.connect(gainNode);
                gainNode.connect(ctx.destination);
                osc.start();
                osc.stop(ctx.currentTime + 0.06);
            }

            // Helper evaluasi sederhana untuk bot medium/hard
            function getPieceValue(piece) {
                if (!piece) return 0;
                switch(piece.type) {
                    case 'p': return 1;
                    case 'n': return 3;
                    case 'b': return 3;
                    case 'r': return 5;
                    case 'q': return 9;
                    case 'k': return 100;
                    default: return 0;
                }
            }

            function makeBotMove() {
                if (gameMode !== 'vsbot' || game.game_over() || game.turn() !== 'b') return;
                var moves = game.moves({ verbose: true });
                if (moves.length === 0) return;
                var selectedMove;
                if (currentLevel === 'easy') {
                    selectedMove = moves[Math.floor(Math.random() * moves.length)];
                }
                else if (currentLevel === 'medium') {
                    var captures = moves.filter(m => m.flags.includes('c'));
                    if (captures.length > 0) {
                        selectedMove = captures[Math.floor(Math.random() * captures.length)];
                    } else {
                        selectedMove = moves[Math.floor(Math.random() * moves.length)];
                    }
                }
                else if (currentLevel === 'hard') {
                    var bestScore = -Infinity;
                    for (let m of moves) {
                        game.move(m);
                        var opponentMoves = game.moves({ verbose: true });
                        var worstScore = Infinity;
                        for (let om of opponentMoves) {
                            game.move(om);
                            var score = evaluateBoard();
                            if (score < worstScore) worstScore = score;
                            game.undo();
                        }
                        if (opponentMoves.length === 0) worstScore = evaluateBoard();
                        if (worstScore > bestScore) {
                            bestScore = worstScore;
                            selectedMove = m;
                        }
                        game.undo();
                    }
                }
                else if (currentLevel === 'extrem' && extremUnlocked) {
                    var bestScore = -Infinity;
                    for (let m of moves) {
                        game.move(m);
                        var score = -negamax(2, -Infinity, Infinity, -1);
                        if (score > bestScore) {
                            bestScore = score;
                            selectedMove = m;
                        }
                        game.undo();
                    }
                } else {
                    selectedMove = moves[Math.floor(Math.random() * moves.length)];
                }
                if (selectedMove) {
                    game.move(selectedMove);
                    board.position(game.fen());
                    playMoveSound();
                    updateTurnIndicators();
                }
            }

            function evaluateBoard() {
                var boardState = game.board();
                var score = 0;
                for (let row of boardState) {
                    for (let piece of row) {
                        if (piece) {
                            var val = getPieceValue(piece);
                            if (piece.color === 'b') score += val;
                            else score -= val;
                        }
                    }
                }
                return score;
            }

            function negamax(depth, alpha, beta, color) {
                if (depth === 0 || game.game_over()) {
                    return color * evaluateBoard();
                }
                var moves = game.moves({ verbose: true });
                var best = -Infinity;
                for (let m of moves) {
                    game.move(m);
                    var score = -negamax(depth - 1, -beta, -alpha, -color);
                    game.undo();
                    best = Math.max(best, score);
                    alpha = Math.max(alpha, score);
                    if (alpha >= beta) break;
                }
                return best;
            }

            function setMode(mode) {
                gameMode = mode;
                $('#mode2p, #modeBot, #modeOnline').removeClass('active');
                if (mode === '2player') $('#mode2p').addClass('active');
                else if (mode === 'vsbot') $('#modeBot').addClass('active');
                else if (mode === 'online') $('#modeOnline').addClass('active');

                if (mode === 'online') {
                    $('#onlinePanel').show();
                    $('#levelSelector, #vipPanel').hide();
                } else {
                    $('#onlinePanel').hide();
                    if (mode === 'vsbot') {
                        $('#levelSelector').show();
                        if (currentLevel === 'extrem' && !extremUnlocked) {
                            $('#vipPanel').show();
                        } else {
                            $('#vipPanel').hide();
                        }
                    } else {
                        $('#levelSelector, #vipPanel').hide();
                    }
                    if (conn) conn.close();
                    if (peer) peer.destroy();
                    peer = null; conn = null; onlineConnected = false;
                    $onlineStatus.text('Status: Offline');
                    $myPeerId.text('');
                }
            }

            function updateScoreUI() { $scoreWhite.text(scoreWhite); $scoreBlack.text(scoreBlack); }
            
            // ========== LEADERBOARD GLOBAL (RIBUAN) ==========
            let leaderboardData = [];
            const STORAGE_LEADERBOARD = 'catur_leaderboard';
            const STORAGE_VISITOR = 'catur_visitor';

            // Visitor count
            let visitorCount = localStorage.getItem(STORAGE_VISITOR);
            if (visitorCount) {
                visitorCount = parseInt(visitorCount) + 1;
            } else {
                visitorCount = 1;
            }
            localStorage.setItem(STORAGE_VISITOR, visitorCount);
            $('#visitorCount').text('üë• ' + visitorCount);

            // Generate 1000+ dummy leaderboard entries
            function generateDummyLeaderboard(count) {
                let names = ['Alpha', 'Beta', 'Gamma', 'Delta', 'Epsilon', 'Zeta', 'Eta', 'Theta', 'Iota', 'Kappa',
                    'Lambda', 'Mu', 'Nu', 'Xi', 'Omicron', 'Pi', 'Rho', 'Sigma', 'Tau', 'Upsilon', 'Phi', 'Chi', 'Psi', 'Omega',
                    'Thunder', 'Shadow', 'Blaze', 'Frost', 'Venom', 'Ghost', 'Reaper', 'Hunter', 'Rogue', 'Mage', 'Knight',
                    'Bishop', 'Rook', 'Queen', 'King', 'Pawn', 'ChessMaster', 'GM', 'IM', 'FM', 'CM', 'WGM', 'WIM', 'WFM',
                    'Bot1', 'Bot2', 'Bot3', 'AI', 'DeepBlue', 'Stockfish', 'Leela', 'AlphaZero', 'Komodo', 'Houdini'
                ];
                let data = [];
                for (let i = 0; i < count; i++) {
                    let name = names[Math.floor(Math.random() * names.length)] + '_' + (Math.floor(Math.random() * 9000) + 1000);
                    let wins = Math.floor(Math.random() * 200);
                    let coins = wins * 15 + Math.floor(Math.random() * 100);
                    data.push({ name, wins, coins });
                }
                return data;
            }

            // Load leaderboard (gabung dengan dummy jika kosong)
            function loadLeaderboard() {
                let stored = localStorage.getItem(STORAGE_LEADERBOARD);
                if (stored) {
                    try {
                        leaderboardData = JSON.parse(stored);
                    } catch (e) {
                        leaderboardData = [];
                    }
                }
                // Jika kosong atau sedikit, tambah dummy
                if (leaderboardData.length < 1000) {
                    let dummy = generateDummyLeaderboard(1200);
                    leaderboardData = [...leaderboardData, ...dummy];
                }
                // Simpan kembali agar konsisten
                localStorage.setItem(STORAGE_LEADERBOARD, JSON.stringify(leaderboardData));
                renderLeaderboard();
            }

            // Render top 100
            function renderLeaderboard() {
                let tbody = $('#leaderboardBody');
                if (leaderboardData.length === 0) {
                    tbody.html('<tr><td colspan="3" style="text-align:center;">Belum ada data</td></tr>');
                    return;
                }
                // Sort by coins descending
                let sorted = [...leaderboardData].sort((a,b) => b.coins - a.coins);
                let top100 = sorted.slice(0, 100);
                let html = '';
                top100.forEach(entry => {
                    html += `<tr><td>${escapeHtml(entry.name)}</td><td>${entry.wins}</td><td>${entry.coins} ü™ô</td></tr>`;
                });
                tbody.html(html);
            }

            function escapeHtml(text) {
                return String(text).replace(/[&<>"]/g, function(m) {
                    if (m === '&') return '&amp;';
                    if (m === '<') return '&lt;';
                    if (m === '>') return '&gt;';
                    if (m === '"') return '&quot;';
                    return m;
                });
            }

            // Add win to current player (menggunakan deviceId sebagai nama)
            function addWinToPlayer() {
                let playerName = deviceId; // gunakan deviceId sebagai identitas unik
                let found = leaderboardData.find(p => p.name === playerName);
                if (found) {
                    found.wins += 1;
                    found.coins += 15;
                } else {
                    leaderboardData.push({ name: playerName, wins: 1, coins: 15 });
                }
                localStorage.setItem(STORAGE_LEADERBOARD, JSON.stringify(leaderboardData));
                renderLeaderboard();
            }

            // ========== GENERATE 500+ ONLINE PLAYERS ==========
            function generateOnlinePlayers(count) {
                let avatars = [];
                for (let i = 0; i < count; i++) {
                    let online = Math.random() > 0.3; // 70% online
                    let name = 'Player_' + (Math.floor(Math.random() * 9000) + 1000);
                    let imgId = Math.floor(Math.random() * 1000);
                    avatars.push({
                        name,
                        img: `https://i.pravatar.cc/50?u=${imgId}`,
                        online
                    });
                }
                return avatars;
            }

            let onlinePlayers = generateOnlinePlayers(500);

            function renderOnlinePlayers() {
                let container = $('.online-players-list');
                container.empty();
                onlinePlayers.forEach(p => {
                    let item = $(`
                        <div class="avatar-list-item">
                            <img src="${p.img}" alt="avatar">
                            <span>${p.name}</span>
                            <span class="dot-list ${p.online ? 'online' : 'offline'}"></span>
                        </div>
                    `);
                    container.append(item);
                });
            }

            renderOnlinePlayers();

            $('.online-toggle-btn').click(function() {
                $('.online-players-list').slideToggle();
            });

            // ========== UPDATE TURN INDICATORS + WIN ==========
            function updateTurnIndicators() {
                if (game.game_over()) {
                    if (game.in_checkmate()) {
                        var winnerColor = game.turn() === 'w' ? 'black' : 'white';
                        if (winnerColor === 'white') {
                            scoreWhite++;
                            addWinToPlayer(); // tambah koin untuk device ini
                        } else {
                            scoreBlack++;
                            // untuk mode 2p atau online, kita juga tambah koin? tapi deviceId sama, jadi tidak adil.
                            // untuk kesederhanaan, hanya putih yang dapat koin di vsbot, dan di mode lain kita tetap tambah.
                            if (gameMode === '2player' || gameMode === 'online') {
                                addWinToPlayer();
                            }
                        }
                        updateScoreUI();
                        alert((winnerColor === 'white' ? 'Putih' : 'Hitam') + ' menang!');
                    } else {
                        alert('Seri!');
                    }
                    return;
                }
                var turn = game.turn();
                $('#white-turn').toggleClass('active', turn === 'w');
                $('#black-turn').toggleClass('active', turn === 'b');
            }

            function sendMove(move) {
                if (conn && conn.open) conn.send({ type: 'move', from: move.from, to: move.to, promotion: 'q' });
            }
            function applyRemoteMove(moveData) {
                var move = game.move({ from: moveData.from, to: moveData.to, promotion: moveData.promotion });
                if (move) { board.position(game.fen()); playMoveSound(); updateTurnIndicators(); }
            }

            var boardConfig = {
                draggable: true,
                position: 'start',
                pieceTheme: pieceTheme,
                onDragStart: function(source, piece, pos, orient) {
                    if (game.game_over()) return false;
                    if (gameMode === 'online') {
                        if (!onlineConnected) { alert('Belum terhubung'); return false; }
                        var turn = game.turn();
                        if (isHost && turn === 'w') return true;
                        if (!isHost && turn === 'b') return true;
                        return false;
                    } else if (gameMode === 'vsbot') {
                        return game.turn() === 'w' && piece.search(/^w/) !== -1;
                    } else if (gameMode === '2player') {
                        var turn = game.turn();
                        return (turn === 'w' && piece.search(/^w/) !== -1) || (turn === 'b' && piece.search(/^b/) !== -1);
                    }
                    return false;
                },
                onDrop: function(source, target) {
                    var move = game.move({ from: source, to: target, promotion: 'q' });
                    if (!move) { alert('Langkah tidak sah'); return 'snapback'; }
                    board.position(game.fen());
                    playMoveSound();
                    updateTurnIndicators();
                    if (gameMode === 'online' && conn && conn.open) sendMove(move);
                    if (gameMode === 'vsbot' && !game.game_over()) setTimeout(makeBotMove, 200);
                    return true;
                },
                onSnapEnd: function() { board.position(game.fen()); }
            };

            board = Chessboard('board', boardConfig);
            updateTurnIndicators();
            updateScoreUI();
            loadLeaderboard();

            // Mode buttons
            $('#mode2p').click(() => setMode('2player'));
            $('#modeBot').click(() => setMode('vsbot'));
            $('#modeOnline').click(() => setMode('online'));

            // Level buttons
            $('#levelEasy').click(function() {
                $('.level-btn').removeClass('active');
                $(this).addClass('active');
                currentLevel = 'easy';
                $('#vipPanel').hide();
            });
            $('#levelMedium').click(function() {
                $('.level-btn').removeClass('active');
                $(this).addClass('active');
                currentLevel = 'medium';
                $('#vipPanel').hide();
            });
            $('#levelHard').click(function() {
                $('.level-btn').removeClass('active');
                $(this).addClass('active');
                currentLevel = 'hard';
                $('#vipPanel').hide();
            });
            $('#levelExtrem').click(function() {
                $('.level-btn').removeClass('active');
                $(this).addClass('active');
                currentLevel = 'extrem';
                if (!extremUnlocked) $('#vipPanel').show();
                else $('#vipPanel').hide();
            });

            $('#unlockVip').click(function() {
                var key = $('#vipKey').val().trim();
                if (key === deviceId) {
                    extremUnlocked = true;
                    localStorage.setItem('catur_extremUnlocked', 'true');
                    $('#vipPanel').hide();
                    alert('Mode Extrem terbuka! Selamat bermain.');
                } else {
                    alert('Kunci salah! Kunci hanya berlaku untuk device ini.');
                }
            });

            let clickCount = 0;
            let clickTimer = null;
            $('.left-symbol').on('click', function() {
                clickCount++;
                if (clickTimer) clearTimeout(clickTimer);
                clickTimer = setTimeout(() => { clickCount = 0; }, 2000);
                if (clickCount >= 5) {
                    clickCount = 0;
                    alert('Kunci device Anda: ' + deviceId + '\nGunakan kunci ini untuk membuka mode Extrem.\n(Kunci bersifat unik untuk device ini)');
                }
            });

            // Online Host
            $('#hostBtn').click(() => {
                myName = $('#nameInput').val().trim() || 'Host';
                if (peer) peer.destroy();
                peer = new Peer();
                peer.on('open', id => {
                    myId = id; isHost = true; onlineConnected = false;
                    $onlineStatus.text('Status: Menunggu lawan...');
                    $myPeerId.text('ID: ' + id);
                });
                peer.on('connection', c => {
                    conn = c;
                    conn.on('open', () => {
                        onlineConnected = true;
                        conn.send({ type: 'name', name: myName });
                        $onlineStatus.text('Status: Terhubung (Putih)');
                        game.reset(); board.position(game.fen()); updateTurnIndicators();
                    });
                    conn.on('data', d => {
                        if (d.type === 'move') applyRemoteMove(d);
                        else if (d.type === 'name') {
                            opponentName = d.name;
                        }
                    });
                    conn.on('close', () => { onlineConnected = false; $onlineStatus.text('Status: Putus'); });
                });
            });

            $('#joinBtn').click(() => {
                myName = $('#nameInput').val().trim() || 'Player';
                var targetId = $('#peerIdInput').val().trim();
                if (!targetId) { alert('Masukkan ID lawan'); return; }
                if (peer) peer.destroy();
                peer = new Peer();
                peer.on('open', id => {
                    myId = id; isHost = false;
                    $myPeerId.text('ID: ' + id);
                    conn = peer.connect(targetId);
                    conn.on('open', () => {
                        onlineConnected = true;
                        conn.send({ type: 'name', name: myName });
                        $onlineStatus.text('Status: Terhubung (Hitam)');
                        game.reset(); board.position(game.fen()); updateTurnIndicators();
                    });
                    conn.on('data', d => {
                        if (d.type === 'move') applyRemoteMove(d);
                        else if (d.type === 'name') {
                            opponentName = d.name;
                        }
                    });
                    conn.on('close', () => { onlineConnected = false; $onlineStatus.text('Status: Putus'); });
                });
            });

            $('#newGameBtn').click(() => { game.reset(); board.position(game.fen()); updateTurnIndicators(); });
            $('#resetScoreBtn').click(() => { scoreWhite = 0; scoreBlack = 0; updateScoreUI(); });

            setMode('vsbot');

            let lagFixActive = false;
            $('#hamburgerBtn').click(e => { e.stopPropagation(); $('#hamburgerDropdown').toggleClass('show'); });
            $(document).click(() => $('#hamburgerDropdown').removeClass('show'));
            $('#hamburgerDropdown').click(e => e.stopPropagation());
            $('#fixLagBtn').click(function() {
                lagFixActive = !lagFixActive;
                if (lagFixActive) { ParticleSystem.stop(); $(this).text('Fix Lag: On'); }
                else { ParticleSystem.start(); $(this).text('Fix Lag: Off'); }
                $('#hamburgerDropdown').removeClass('show');
            });
        });
    </script>
</body>
</html>
