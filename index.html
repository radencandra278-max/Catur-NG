<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>‰∏â 0 ¬∑ Catur Online + LED + Partikel</title>
    <!-- chessboard.js CSS -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/chessboard-js/1.0.0/chessboard-1.0.0.min.css">
    <!-- PeerJS for WebRTC -->
    <script src="https://unpkg.com/peerjs@1.5.4/dist/peerjs.min.js"></script>
    <style>
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }
        body {
            background: linear-gradient(145deg, #0f1a24 0%, #0b131c 100%);
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            font-family: 'Segoe UI', Roboto, system-ui, sans-serif;
            margin: 0;
            padding: 16px;
            position: relative;
            overflow-x: hidden;
        }
        /* Canvas partikel di latar belakang */
        #particle-canvas {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 0;
        }
        /* Container utama dengan efek transparan / glassmorphism */
        .game-container {
            background: rgba(48, 64, 82, 0.65);
            backdrop-filter: blur(8px);
            -webkit-backdrop-filter: blur(8px);
            padding: 28px 24px 32px 24px;
            border-radius: 42px;
            box-shadow: 0 25px 35px -8px rgba(0,0,0,0.5), inset 0 0 0 1px rgba(255,255,255,0.15);
            border: 1px solid rgba(255,255,255,0.2);
            max-width: 800px;
            width: fit-content;
            position: relative;
            z-index: 1;
        }
        .header {
            display: flex;
            flex-wrap: wrap;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 22px;
            padding: 0 8px;
            color: #f0ead2;
            text-shadow: 0 2px 5px rgba(0,0,0,0.5);
            gap: 15px;
        }
        .left-symbol {
            font-size: 2.2rem;
            font-weight: 400;
            letter-spacing: 4px;
            background: rgba(38, 50, 63, 0.8);
            padding: 8px 22px;
            border-radius: 60px;
            box-shadow: inset 0 2px 5px rgba(0,0,0,0.3), 0 5px 0 rgba(27,37,48,0.5);
            border-bottom: 2px solid rgba(127,155,181,0.6);
            line-height: 1;
            color: #f2e9d0;
            backdrop-filter: blur(4px);
        }
        .score-box {
            background: rgba(49, 67, 81, 0.8);
            padding: 8px 25px;
            border-radius: 48px;
            box-shadow: inset 0 2px 5px rgba(0,0,0,0.3), 0 6px 0 rgba(29,42,51,0.5);
            border-bottom: 2px solid rgba(136,160,184,0.6);
            font-size: 1.5rem;
            font-weight: 600;
            color: #f9e7b3;
            display: flex;
            gap: 30px;
            backdrop-filter: blur(4px);
        }
        .score-item {
            display: flex;
            align-items: center;
            gap: 6px;
        }
        .score-badge {
            background: rgba(29, 43, 54, 0.9);
            border-radius: 40px;
            padding: 2px 14px;
            font-size: 1.4rem;
            color: #ecd79b;
            border: 1px solid rgba(165,193,217,0.5);
        }
        .turn-indicators {
            display: flex;
            gap: 20px;
            background: rgba(49, 67, 81, 0.8);
            padding: 10px 24px;
            border-radius: 48px;
            box-shadow: inset 0 2px 5px rgba(0,0,0,0.3), 0 6px 0 rgba(29,42,51,0.5);
            border-bottom: 2px solid rgba(136,160,184,0.6);
            backdrop-filter: blur(4px);
        }
        .turn-indicator {
            font-size: 1.2rem;
            font-weight: 500;
            padding: 6px 18px;
            border-radius: 40px;
            background: rgba(64, 89, 107, 0.9);
            color: #b6cdde;
            transition: all 0.15s;
            box-shadow: 0 2px 0 rgba(37,50,62,0.5);
            cursor: default;
            border: 1px solid rgba(119,149,173,0.5);
        }
        .turn-indicator.active {
            background: #ecd79b;
            color: #1d2f3f;
            font-weight: 600;
            box-shadow: 0 4px 0 #a08441, 0 0 12px #ffde9e;
            border-color: #fde5b1;
            transform: translateY(-2px);
        }
        .mode-selector {
            display: flex;
            justify-content: center;
            gap: 15px;
            margin: 15px 0 10px;
            flex-wrap: wrap;
        }
        .mode-btn {
            background: rgba(44, 63, 78, 0.8);
            border: none;
            border-bottom: 4px solid rgba(23,35,43,0.8);
            color: #dbd1b2;
            font-size: 1.2rem;
            font-weight: 600;
            padding: 10px 30px;
            border-radius: 40px;
            cursor: pointer;
            box-shadow: 0 5px 0 rgba(14,26,34,0.5), 0 5px 12px black;
            transition: 0.06s linear;
            border: 1px solid rgba(98,130,150,0.6);
            flex: 0 1 auto;
            backdrop-filter: blur(4px);
        }
        .mode-btn.active {
            background: #ecd79b;
            color: #1f333f;
            border-bottom-color: #a58542;
            transform: translateY(2px);
            box-shadow: 0 2px 0 #0e1a22, 0 8px 12px black;
        }

        /* Panel online */
        .online-panel {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 10px;
            margin: 15px 0;
            background: rgba(30, 40, 50, 0.6);
            backdrop-filter: blur(4px);
            border-radius: 60px;
            padding: 15px 25px;
            border: 1px solid rgba(255,255,255,0.2);
        }
        .online-row {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            justify-content: center;
        }
        .online-input {
            background: rgba(20, 30, 40, 0.8);
            border: 1px solid rgba(255,255,255,0.3);
            color: #fff;
            padding: 10px 20px;
            border-radius: 40px;
            font-size: 1rem;
            outline: none;
            min-width: 200px;
        }
        .online-input::placeholder {
            color: #a0b0c0;
        }
        .online-btn {
            background: #2e4e5e;
            border: none;
            border-bottom: 3px solid #1a2f3a;
            color: white;
            padding: 10px 25px;
            border-radius: 40px;
            font-weight: 600;
            cursor: pointer;
            transition: 0.05s linear;
            box-shadow: 0 4px 0 #0e1a22;
        }
        .online-btn:active {
            transform: translateY(3px);
            border-bottom-width: 1px;
            box-shadow: 0 1px 0 #0e1a22;
        }
        .online-status {
            color: #b0e0ff;
            font-size: 1.1rem;
            text-shadow: 0 2px 3px black;
        }

        .board-wrapper {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            margin: 15px 0 25px 0;
            filter: drop-shadow(0 18px 15px #141e26);
        }

        /* strip LED */
        .led-strip {
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            gap: 8px 12px;
            margin: 10px 0;
            padding: 0 10px;
            pointer-events: none;
        }

        .led {
            width: 18px;
            height: 18px;
            border-radius: 50%;
            background: #ffaa00;
            box-shadow: 0 0 12px currentColor;
            animation: blink 1.8s infinite ease-in-out;
            flex-shrink: 0;
        }

        .led:nth-child(1) { background: #ff4d4d; animation-delay: 0.0s; }
        .led:nth-child(2) { background: #ffdb4d; animation-delay: 0.2s; }
        .led:nth-child(3) { background: #4dff4d; animation-delay: 0.4s; }
        .led:nth-child(4) { background: #4dffff; animation-delay: 0.6s; }
        .led:nth-child(5) { background: #4d4dff; animation-delay: 0.8s; }
        .led:nth-child(6) { background: #ff4dff; animation-delay: 1.0s; }
        .led:nth-child(7) { background: #ff884d; animation-delay: 0.3s; }
        .led:nth-child(8) { background: #88ff4d; animation-delay: 0.5s; }
        .led:nth-child(9) { background: #4dff88; animation-delay: 0.7s; }
        .led:nth-child(10) { background: #4d88ff; animation-delay: 0.9s; }
        .led:nth-child(11) { background: #ff4d88; animation-delay: 1.1s; }
        .led:nth-child(12) { background: #ffaa4d; animation-delay: 1.3s; }

        @keyframes blink {
            0%, 100% { opacity: 1; transform: scale(1); }
            50% { opacity: 0.2; transform: scale(0.7); }
        }

        /* Baris yang memuat papan dan avatar di kiri/kanan */
        .board-row {
            display: flex;
            flex-direction: row;
            align-items: center;
            justify-content: center;
            gap: 15px;
            margin: 10px 0;
        }

        /* area avatar kiri & kanan */
        .online-players {
            display: flex;
            flex-direction: column;
            gap: 15px;
            background: rgba(30, 40, 50, 0.5);
            backdrop-filter: blur(4px);
            padding: 15px 10px;
            border-radius: 50px;
            border: 1px solid rgba(255,255,255,0.15);
            box-shadow: 0 8px 15px rgba(0,0,0,0.3);
        }

        .avatar {
            position: relative;
            width: 60px;
            height: 60px;
            border-radius: 50%;
            background: rgba(220, 220, 240, 0.15);
            border: 2px solid rgba(255,255,255,0.3);
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 1.2rem;
            color: #fff;
            text-shadow: 0 2px 3px black;
            box-shadow: 0 4px 8px rgba(0,0,0,0.3);
            backdrop-filter: blur(2px);
            transition: 0.2s;
        }
        .avatar:hover {
            transform: scale(1.05);
            border-color: #a0c0ff;
            background: rgba(255,255,255,0.2);
        }
        .avatar span:first-child {
            z-index: 2;
        }
        .dot {
            position: absolute;
            bottom: 5px;
            right: 5px;
            width: 14px;
            height: 14px;
            border-radius: 50%;
            background: #4caf50; /* hijau online */
            border: 2px solid #1e2a36;
            box-shadow: 0 0 8px #00ff80;
        }
        .dot.offline {
            background: #9e9e9e;
            box-shadow: none;
        }

        #board {
            width: 480px;
            height: 480px;
            border-radius: 20px;
            overflow: hidden;
            border: 4px solid rgba(90, 111, 130, 0.8);
            box-shadow: inset 0 0 0 2px rgba(217,200,169,0.5), 0 10px 10px rgba(0,0,0,0.5);
        }

        .white-1e1d7 {
            background-color: rgba(237, 238, 213, 0.9) !important;
        }
        .black-3c85d {
            background-color: rgba(97, 147, 145, 0.9) !important;
        }
        .footer {
            display: flex;
            justify-content: center;
            gap: 20px;
            margin-top: 22px;
            flex-wrap: wrap;
        }
        .action-btn {
            background: rgba(49, 77, 92, 0.85);
            border: none;
            border-bottom: 5px solid rgba(30,47,59,0.8);
            color: #fcf3dd;
            font-size: 1.4rem;
            font-weight: 600;
            padding: 12px 30px;
            border-radius: 60px;
            letter-spacing: 1px;
            cursor: pointer;
            box-shadow: 0 8px 0 rgba(21,34,43,0.5), 0 8px 18px black;
            transition: 0.07s linear;
            text-transform: uppercase;
            border: 1px solid rgba(120,155,179,0.6);
            backdrop-filter: blur(4px);
        }
        .action-btn:active {
            transform: translateY(5px);
            border-bottom-width: 2px;
            box-shadow: 0 3px 0 #15222b, 0 8px 12px black;
        }
        .reset-score-btn {
            background: rgba(79, 67, 67, 0.85);
            border-bottom-color: rgba(49,42,42,0.8);
        }

        @media (max-width: 750px) {
            .board-row {
                flex-wrap: wrap;
            }
            .online-players {
                flex-direction: row;
                order: 2;
                margin-top: 15px;
            }
            .left, .right {
                order: 2;
            }
            #board {
                order: 1;
            }
            .game-container {
                max-width: 550px;
            }
        }
        @media (max-width: 550px) {
            #board { width: 360px; height: 360px; }
            .led { width: 14px; height: 14px; }
            .turn-indicator { font-size: 0.9rem; padding: 4px 10px; }
            .left-symbol { font-size: 1.6rem; padding: 4px 16px; }
            .score-box { font-size: 1.2rem; padding: 5px 15px; gap: 15px; }
            .mode-btn { font-size: 1rem; padding: 8px 18px; }
            .avatar { width: 45px; height: 45px; font-size: 1rem; }
            .dot { width: 10px; height: 10px; }
        }
    </style>
    <!-- jQuery, chess.js, chessboardjs -->
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/chess.js/0.10.3/chess.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/chessboard-js/1.0.0/chessboard-1.0.0.min.js"></script>
</head>
<body>
    <canvas id="particle-canvas"></canvas>

    <div class="game-container">
        <div class="header">
            <div class="left-symbol">‰∏â 0</div>
            <div class="score-box">
                <div class="score-item">‚ö™ <span id="scoreWhite" class="score-badge">0</span></div>
                <div class="score-item">‚ö´ <span id="scoreBlack" class="score-badge">0</span></div>
            </div>
            <div class="turn-indicators">
                <span id="white-turn" class="turn-indicator active">1. White's move</span>
                <span id="black-turn" class="turn-indicator">2. Black's move</span>
            </div>
        </div>

        <div class="mode-selector">
            <button id="mode2p" class="mode-btn">üë• 2 Player</button>
            <button id="modeBot" class="mode-btn">ü§ñ Vs Bot</button>
            <button id="modeOnline" class="mode-btn active">üåê Online</button>
        </div>

        <!-- Panel Online (muncul jika mode online aktif) -->
        <div id="onlinePanel" class="online-panel">
            <div class="online-row">
                <input type="text" id="peerIdInput" class="online-input" placeholder="Masukkan ID lawan">
                <button id="hostBtn" class="online-btn">üéÆ Host Game</button>
                <button id="joinBtn" class="online-btn">üîó Join Game</button>
            </div>
            <div class="online-row">
                <span id="onlineStatus" class="online-status">Status: Offline</span>
                <span id="myPeerId" class="online-status"></span>
            </div>
        </div>

        <div class="board-wrapper">
            <div class="led-strip">
                <div class="led"></div><div class="led"></div><div class="led"></div><div class="led"></div>
                <div class="led"></div><div class="led"></div><div class="led"></div><div class="led"></div>
                <div class="led"></div><div class="led"></div><div class="led"></div><div class="led"></div>
            </div>

            <div class="board-row">
                <div class="online-players left">
                    <div class="avatar"><span>P1</span><span class="dot"></span></div>
                    <div class="avatar"><span>P2</span><span class="dot"></span></div>
                    <div class="avatar"><span>P3</span><span class="dot offline"></span></div>
                    <div class="avatar"><span>P4</span><span class="dot"></span></div>
                </div>

                <div id="board"></div>

                <div class="online-players right">
                    <div class="avatar"><span>P5</span><span class="dot"></span></div>
                    <div class="avatar"><span>P6</span><span class="dot"></span></div>
                    <div class="avatar"><span>P7</span><span class="dot offline"></span></div>
                    <div class="avatar"><span>P8</span><span class="dot"></span></div>
                </div>
            </div>

            <div class="led-strip">
                <div class="led"></div><div class="led"></div><div class="led"></div><div class="led"></div>
                <div class="led"></div><div class="led"></div><div class="led"></div><div class="led"></div>
                <div class="led"></div><div class="led"></div><div class="led"></div><div class="led"></div>
            </div>
        </div>

        <div class="footer">
            <button class="action-btn" id="newGameBtn">‚Ü∫ New Game</button>
            <button class="action-btn reset-score-btn" id="resetScoreBtn">‚ü≤ Reset Score</button>
        </div>
    </div>

    <script>
        // ==================== PARTIKEL ====================
        (function() {
            const canvas = document.getElementById('particle-canvas');
            const ctx = canvas.getContext('2d');
            let width, height;
            let particles = [];

            function initParticles() {
                const particleCount = 70;
                for (let i = 0; i < particleCount; i++) {
                    particles.push({
                        x: Math.random() * width,
                        y: Math.random() * height,
                        vx: (Math.random() - 0.5) * 0.4,
                        vy: (Math.random() - 0.5) * 0.2,
                        radius: Math.random() * 3 + 1.5,
                        color: `hsl(${Math.random() * 60 + 200}, 80%, 70%)`,
                        alpha: Math.random() * 0.6 + 0.2,
                        blinkSpeed: Math.random() * 0.02 + 0.01,
                        blinkPhase: Math.random() * Math.PI * 2
                    });
                }
            }

            function resizeCanvas() {
                width = window.innerWidth;
                height = window.innerHeight;
                canvas.width = width;
                canvas.height = height;
            }

            function updateParticles() {
                for (let p of particles) {
                    p.x += p.vx;
                    p.y += p.vy;

                    if (p.x < 0) p.x = width;
                    if (p.x > width) p.x = 0;
                    if (p.y < 0) p.y = height;
                    if (p.y > height) p.y = 0;

                    p.alpha = 0.3 + 0.4 * Math.sin(Date.now() * p.blinkSpeed + p.blinkPhase);
                }
            }

            function drawParticles() {
                ctx.clearRect(0, 0, width, height);
                for (let p of particles) {
                    ctx.beginPath();
                    ctx.arc(p.x, p.y, p.radius, 0, Math.PI * 2);
                    ctx.fillStyle = p.color;
                    ctx.globalAlpha = p.alpha;
                    ctx.fill();
                    ctx.shadowColor = p.color;
                    ctx.shadowBlur = 10;
                    ctx.fill();
                    ctx.shadowBlur = 0;
                }
                ctx.globalAlpha = 1.0;
            }

            function animate() {
                updateParticles();
                drawParticles();
                requestAnimationFrame(animate);
            }

            window.addEventListener('resize', () => {
                resizeCanvas();
            });

            resizeCanvas();
            initParticles();
            animate();
        })();

        // ==================== LOGIKA CATUR + ONLINE ====================
        $(document).ready(function() {
            var game = new Chess();
            var pieceTheme = 'https://chessboardjs.com/img/chesspieces/wikipedia/{piece}.png';
            var gameMode = 'online'; // default online
            var scoreWhite = 0;
            var scoreBlack = 0;
            var $scoreWhite = $('#scoreWhite');
            var $scoreBlack = $('#scoreBlack');
            var board;

            // Variabel online
            var peer = null;
            var conn = null;
            var myId = null;
            var isHost = false; // host = putih, join = hitam
            var onlineConnected = false;
            var $onlineStatus = $('#onlineStatus');
            var $myPeerId = $('#myPeerId');

            // Update UI mode
            function setMode(mode) {
                gameMode = mode;
                $('#mode2p, #modeBot, #modeOnline').removeClass('active');
                if (mode === '2player') $('#mode2p').addClass('active');
                else if (mode === 'vsbot') $('#modeBot').addClass('active');
                else if (mode === 'online') $('#modeOnline').addClass('active');
                // Tampilkan panel online hanya jika mode online
                if (mode === 'online') {
                    $('#onlinePanel').show();
                } else {
                    $('#onlinePanel').hide();
                    // Putuskan koneksi jika ada
                    if (conn) conn.close();
                    if (peer) peer.destroy();
                    peer = null;
                    conn = null;
                    onlineConnected = false;
                    $onlineStatus.text('Status: Offline');
                    $myPeerId.text('');
                }
            }

            // Update skor
            function updateScoreUI() {
                $scoreWhite.text(scoreWhite);
                $scoreBlack.text(scoreBlack);
            }

            // Update indikator giliran
            function updateTurnIndicators() {
                if (game.game_over()) {
                    if (game.in_checkmate()) {
                        var winnerColor = game.turn() === 'w' ? 'black' : 'white';
                        var winnerName = winnerColor === 'white' ? 'Putih' : 'Hitam';
                        if (winnerColor === 'white') scoreWhite++;
                        else scoreBlack++;
                        updateScoreUI();
                        alert('üèÜ ' + winnerName + ' menang! Skor diperbarui.');
                        
                        $('#white-turn, #black-turn').removeClass('active');
                        $('#white-turn').text('1. ' + (winnerColor === 'white' ? 'White wins' : 'Checkmate'));
                        $('#black-turn').text('2. ' + (winnerColor === 'black' ? 'Black wins' : 'Checkmate'));
                    } else {
                        $('#white-turn, #black-turn').removeClass('active');
                        $('#white-turn').text('1. Game over');
                        $('#black-turn').text('2. Draw');
                        alert('ü§ù Permainan berakhir seri.');
                    }
                    return;
                }

                var turn = game.turn();
                if (turn === 'w') {
                    $('#white-turn').addClass('active').text('1. White\'s move');
                    $('#black-turn').removeClass('active').text('2. Black\'s move');
                } else {
                    $('#white-turn').removeClass('active').text('1. White\'s move');
                    $('#black-turn').addClass('active').text('2. Black\'s move');
                }
            }

            // Bot (random)
            function makeBotMove() {
                if (gameMode !== 'vsbot') return;
                if (game.game_over()) {
                    updateTurnIndicators();
                    return;
                }
                if (game.turn() !== 'b') return;
                var moves = game.moves();
                if (moves.length === 0) return;
                var randomIdx = Math.floor(Math.random() * moves.length);
                game.move(moves[randomIdx]);
                board.position(game.fen());
                updateTurnIndicators();
            }

            // Kirim gerakan ke lawan (online)
            function sendMove(move) {
                if (conn && conn.open) {
                    conn.send({
                        type: 'move',
                        from: move.from,
                        to: move.to,
                        promotion: move.promotion || 'q'
                    });
                }
            }

            // Proses gerakan dari lawan
            function applyRemoteMove(moveData) {
                var move = game.move({
                    from: moveData.from,
                    to: moveData.to,
                    promotion: moveData.promotion
                });
                if (move) {
                    board.position(game.fen());
                    updateTurnIndicators();
                } else {
                    console.warn("Invalid remote move", moveData);
                }
            }

            // Konfigurasi board dengan pengecekan giliran online
            var boardConfig = {
                draggable: true,
                position: 'start',
                pieceTheme: pieceTheme,
                onDragStart: function(source, piece, position, orientation) {
                    if (game.game_over()) return false;

                    // Mode online: hanya bisa jika terhubung dan giliran sesuai
                    if (gameMode === 'online') {
                        if (!onlineConnected) {
                            alert('Belum terhubung ke lawan');
                            return false;
                        }
                        var currentTurn = game.turn();
                        if (isHost && currentTurn === 'w') return true;  // host putih
                        if (!isHost && currentTurn === 'b') return true; // join hitam
                        return false; // bukan giliran
                    }
                    // Mode vs bot
                    else if (gameMode === 'vsbot') {
                        if (game.turn() !== 'w') return false;
                        if (piece.search(/^b/) !== -1) return false;
                        return true;
                    }
                    // Mode 2 player
                    else if (gameMode === '2player') {
                        var currentTurn = game.turn();
                        if ((currentTurn === 'w' && piece.search(/^w/) === -1) ||
                            (currentTurn === 'b' && piece.search(/^b/) === -1)) {
                            return false;
                        }
                        return true;
                    }
                    return false;
                },
                onDrop: function(source, target) {
                    var move = game.move({
                        from: source,
                        to: target,
                        promotion: 'q'
                    });

                    if (move === null) {
                        alert('‚ö†Ô∏è Langkah tidak sah!');
                        return 'snapback';
                    }

                    board.position(game.fen());
                    updateTurnIndicators();

                    // Jika online, kirim gerakan ke lawan
                    if (gameMode === 'online' && conn && conn.open) {
                        sendMove(move);
                    }

                    // Jika vs bot, jalankan bot
                    if (gameMode === 'vsbot' && !game.game_over()) {
                        setTimeout(makeBotMove, 200);
                    }

                    return true;
                },
                onSnapEnd: function() {
                    board.position(game.fen());
                }
            };

            board = Chessboard('board', boardConfig);
            updateTurnIndicators();
            updateScoreUI();

            // Event listener mode
            $('#mode2p').on('click', function() { setMode('2player'); });
            $('#modeBot').on('click', function() { setMode('vsbot'); });
            $('#modeOnline').on('click', function() { setMode('online'); });

            // Online: Host
            $('#hostBtn').on('click', function() {
                if (peer) peer.destroy();
                peer = new Peer(); // Buat peer baru dengan ID acak
                peer.on('open', function(id) {
                    myId = id;
                    isHost = true;
                    onlineConnected = false; // masih menunggu koneksi
                    $onlineStatus.text('Status: Menunggu lawan...');
                    $myPeerId.text('ID Anda: ' + id);
                });

                peer.on('connection', function(connection) {
                    conn = connection;
                    conn.on('open', function() {
                        onlineConnected = true;
                        $onlineStatus.text('Status: Terhubung (Anda Putih)');
                        game.reset(); // reset papan
                        board.position(game.fen());
                        updateTurnIndicators();
                    });
                    conn.on('data', function(data) {
                        if (data.type === 'move') {
                            applyRemoteMove(data);
                        }
                    });
                    conn.on('close', function() {
                        onlineConnected = false;
                        $onlineStatus.text('Status: Koneksi terputus');
                    });
                });
            });

            // Online: Join
            $('#joinBtn').on('click', function() {
                var targetId = $('#peerIdInput').val().trim();
                if (!targetId) {
                    alert('Masukkan ID lawan');
                    return;
                }
                if (peer) peer.destroy();
                peer = new Peer();
                peer.on('open', function(id) {
                    myId = id;
                    isHost = false;
                    $myPeerId.text('ID Anda: ' + id);
                    // Sambungkan ke host
                    conn = peer.connect(targetId);
                    conn.on('open', function() {
                        onlineConnected = true;
                        $onlineStatus.text('Status: Terhubung (Anda Hitam)');
                        game.reset();
                        board.position(game.fen());
                        updateTurnIndicators();
                    });
                    conn.on('data', function(data) {
                        if (data.type === 'move') {
                            applyRemoteMove(data);
                        }
                    });
                    conn.on('close', function() {
                        onlineConnected = false;
                        $onlineStatus.text('Status: Koneksi terputus');
                    });
                });
            });

            // New Game
            $('#newGameBtn').on('click', function() {
                game.reset();
                board.position(game.fen());
                updateTurnIndicators();
                // Jika online dan terhubung, reset mungkin perlu disinkronisasi? 
                // Untuk sederhana, kita biarkan masing-masing reset sendiri.
                if (gameMode === 'online' && conn && conn.open) {
                    // Opsional: kirim sinyal reset ke lawan, tetapi tidak diimplementasikan di sini.
                }
            });

            // Reset Skor
            $('#resetScoreBtn').on('click', function() {
                scoreWhite = 0;
                scoreBlack = 0;
                updateScoreUI();
            });

            // Gaya square
            $('.square-55d63').css('box-shadow', 'inset 0 0 4px rgba(0,0,0,0.2)');

            // Inisialisasi: mode online aktif, panel muncul
            setMode('online');
        });
    </script>
</body>
</html>
