<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>‰∏â 0 ¬∑ Catur Online + Identitas + LED + Partikel</title>
    <!-- chessboard.js CSS -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/chessboard-js/1.0.0/chessboard-1.0.0.min.css">
    <!-- PeerJS for WebRTC -->
    <script src="https://unpkg.com/peerjs@1.5.4/dist/peerjs.min.js"></script>
    <style>
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }
        body {
            background: linear-gradient(145deg, #0f1a24 0%, #0b131c 100%);
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            font-family: 'Segoe UI', Roboto, system-ui, sans-serif;
            margin: 0;
            padding: 8px;
            position: relative;
            overflow-x: hidden;
        }
        /* Canvas partikel di latar belakang - lebih ringan */
        #particle-canvas {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 0;
            will-change: transform; /* hint untuk akselerasi */
        }
        /* Container utama tanpa blur */
        .game-container {
            background: rgba(30, 40, 50, 0.85); /* tanpa backdrop-filter */
            padding: 20px 18px 24px 18px;
            border-radius: 36px;
            box-shadow: 0 15px 25px -5px rgba(0,0,0,0.7);
            border: 1px solid rgba(255,255,255,0.15);
            max-width: 800px;
            width: fit-content;
            position: relative;
            z-index: 1;
        }
        .header {
            display: flex;
            flex-wrap: wrap;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 18px;
            padding: 0 5px;
            color: #f0ead2;
            text-shadow: 0 1px 3px black;
            gap: 10px;
        }
        /* left-symbol dihapus */
        .score-box {
            background: rgba(35, 45, 55, 0.95);
            padding: 6px 18px;
            border-radius: 40px;
            box-shadow: inset 0 1px 3px rgba(0,0,0,0.5), 0 4px 0 rgba(20,30,40,0.8);
            border-bottom: 2px solid rgba(100,130,150,0.5);
            font-size: 1.3rem;
            font-weight: 600;
            color: #f9e7b3;
            display: flex;
            gap: 20px;
        }
        .score-item {
            display: flex;
            align-items: center;
            gap: 4px;
        }
        .score-badge {
            background: rgba(20, 30, 40, 0.95);
            border-radius: 30px;
            padding: 2px 12px;
            font-size: 1.2rem;
            color: #ecd79b;
            border: 1px solid rgba(140,170,190,0.5);
        }
        .turn-indicators {
            display: flex;
            gap: 12px;
            background: rgba(35, 45, 55, 0.95);
            padding: 6px 16px;
            border-radius: 40px;
            box-shadow: inset 0 1px 3px rgba(0,0,0,0.5), 0 4px 0 rgba(20,30,40,0.8);
            border-bottom: 2px solid rgba(100,130,150,0.5);
        }
        .turn-indicator {
            font-size: 1rem;
            font-weight: 500;
            padding: 4px 12px;
            border-radius: 30px;
            background: rgba(50, 65, 80, 0.95);
            color: #b6cdde;
            box-shadow: 0 2px 0 rgba(30,40,50,0.5);
            cursor: default;
            border: 1px solid rgba(100,130,150,0.4);
        }
        .turn-indicator.active {
            background: #ecd79b;
            color: #1d2f3f;
            font-weight: 600;
            box-shadow: 0 3px 0 #a08441;
            border-color: #fde5b1;
            transform: translateY(-1px);
        }
        /* Hamburger */
        .hamburger {
            display: flex;
            flex-direction: column;
            justify-content: space-around;
            width: 30px;
            height: 30px;
            background: rgba(40, 50, 60, 0.95);
            border: 1px solid rgba(255,255,255,0.2);
            border-radius: 8px;
            padding: 5px 4px;
            cursor: pointer;
            transition: 0.1s;
            margin-left: 5px;
        }
        .hamburger:hover {
            background: rgba(60, 75, 90, 0.95);
        }
        .hamburger-line {
            width: 100%;
            height: 3px;
            background: #f0ead2;
            border-radius: 3px;
        }
        .hamburger-dropdown {
            position: absolute;
            top: 80px;
            right: 25px;
            background: rgba(30, 40, 50, 0.98);
            border-radius: 14px;
            padding: 10px;
            display: none;
            flex-direction: column;
            border: 1px solid rgba(255,255,255,0.2);
            box-shadow: 0 8px 16px rgba(0,0,0,0.6);
            z-index: 200;
            min-width: 140px;
        }
        .hamburger-dropdown.show {
            display: flex;
        }
        .hamburger-dropdown button {
            background: #2e4e5e;
            border: none;
            color: white;
            padding: 8px 14px;
            border-radius: 24px;
            cursor: pointer;
            font-weight: 600;
            border-bottom: 2px solid #1a2f3a;
            font-size: 0.95rem;
        }
        .hamburger-dropdown button:active {
            transform: translateY(2px);
            border-bottom-width: 1px;
        }
        .mode-selector {
            display: flex;
            justify-content: center;
            gap: 10px;
            margin: 12px 0 8px;
            flex-wrap: wrap;
        }
        .mode-btn {
            background: rgba(40, 55, 70, 0.95);
            border: none;
            border-bottom: 3px solid rgba(20,30,40,0.9);
            color: #dbd1b2;
            font-size: 1.1rem;
            font-weight: 600;
            padding: 8px 20px;
            border-radius: 36px;
            cursor: pointer;
            box-shadow: 0 4px 0 rgba(10,20,30,0.7);
            transition: 0.05s linear;
            border: 1px solid rgba(80,110,130,0.5);
            flex: 0 1 auto;
        }
        .mode-btn.active {
            background: #ecd79b;
            color: #1f333f;
            border-bottom-color: #a58542;
            transform: translateY(2px);
            box-shadow: 0 2px 0 #0e1a22;
        }

        /* Panel online */
        .online-panel {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 8px;
            margin: 10px 0;
            background: rgba(30, 40, 50, 0.95);
            border-radius: 50px;
            padding: 12px 18px;
            border: 1px solid rgba(255,255,255,0.1);
        }
        .online-row {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
            justify-content: center;
            align-items: center;
        }
        .online-input {
            background: rgba(15, 25, 35, 0.95);
            border: 1px solid rgba(255,255,255,0.2);
            color: #fff;
            padding: 8px 16px;
            border-radius: 30px;
            font-size: 0.95rem;
            outline: none;
            min-width: 150px;
        }
        .online-input::placeholder {
            color: #a0b0c0;
        }
        .online-btn {
            background: #2e4e5e;
            border: none;
            border-bottom: 2px solid #1a2f3a;
            color: white;
            padding: 8px 18px;
            border-radius: 30px;
            font-weight: 600;
            cursor: pointer;
            box-shadow: 0 3px 0 #0e1a22;
        }
        .online-btn:active {
            transform: translateY(3px);
            border-bottom-width: 1px;
            box-shadow: 0 1px 0 #0e1a22;
        }
        .online-status {
            color: #b0e0ff;
            font-size: 1rem;
            text-shadow: 0 1px 2px black;
        }

        .board-wrapper {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            margin: 10px 0 15px 0;
            filter: drop-shadow(0 10px 8px #101820);
        }

        /* strip LED - animasi lebih sederhana (hanya opacity) */
        .led-strip {
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            gap: 5px 8px;
            margin: 6px 0;
            padding: 0 5px;
            pointer-events: none;
        }

        .led {
            width: 14px;
            height: 14px;
            border-radius: 50%;
            background: #ffaa00;
            box-shadow: 0 0 5px currentColor;
            animation: fade 2s infinite ease-in-out;
            flex-shrink: 0;
        }

        .led:nth-child(1) { background: #ff4d4d; animation-delay: 0.0s; }
        .led:nth-child(2) { background: #ffdb4d; animation-delay: 0.2s; }
        .led:nth-child(3) { background: #4dff4d; animation-delay: 0.4s; }
        .led:nth-child(4) { background: #4dffff; animation-delay: 0.6s; }
        .led:nth-child(5) { background: #4d4dff; animation-delay: 0.8s; }
        .led:nth-child(6) { background: #ff4dff; animation-delay: 1.0s; }
        .led:nth-child(7) { background: #ff884d; animation-delay: 0.3s; }
        .led:nth-child(8) { background: #88ff4d; animation-delay: 0.5s; }
        .led:nth-child(9) { background: #4dff88; animation-delay: 0.7s; }
        .led:nth-child(10) { background: #4d88ff; animation-delay: 0.9s; }
        .led:nth-child(11) { background: #ff4d88; animation-delay: 1.1s; }
        .led:nth-child(12) { background: #ffaa4d; animation-delay: 1.3s; }

        @keyframes fade {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.3; }
        }

        /* Baris yang memuat papan dan avatar */
        .board-row {
            display: flex;
            flex-direction: row;
            align-items: center;
            justify-content: center;
            gap: 8px;
            margin: 5px 0;
        }

        /* area avatar - tanpa blur */
        .online-players {
            display: flex;
            flex-direction: column;
            gap: 10px;
            background: rgba(25, 35, 45, 0.9);
            padding: 12px 6px;
            border-radius: 40px;
            border: 1px solid rgba(255,255,255,0.1);
            box-shadow: 0 5px 10px rgba(0,0,0,0.3);
        }

        .avatar {
            position: relative;
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background: rgba(180, 190, 210, 0.15);
            border: 2px solid rgba(255,255,255,0.2);
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 1rem;
            color: #fff;
            text-shadow: 0 1px 2px black;
            box-shadow: 0 3px 5px rgba(0,0,0,0.4);
        }
        .avatar span:first-child {
            z-index: 2;
        }
        .dot {
            position: absolute;
            bottom: 3px;
            right: 3px;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background: #4caf50;
            border: 2px solid #1e2a36;
        }
        .dot.offline {
            background: #9e9e9e;
            box-shadow: none;
        }

        #board {
            width: 440px;
            height: 440px;
            border-radius: 16px;
            overflow: hidden;
            border: 3px solid rgba(80, 100, 120, 0.9);
            box-shadow: inset 0 0 0 1px rgba(200,180,150,0.3), 0 6px 8px rgba(0,0,0,0.5);
            touch-action: none;
            -webkit-user-select: none;
            user-select: none;
        }

        .white-1e1d7 {
            background-color: rgba(230, 225, 200, 0.9) !important;
        }
        .black-3c85d {
            background-color: rgba(80, 120, 120, 0.9) !important;
        }

        .square-55d63 {
            touch-action: none;
            -webkit-user-select: none;
            user-select: none;
        }

        .footer {
            display: flex;
            justify-content: center;
            gap: 15px;
            margin-top: 16px;
            flex-wrap: wrap;
        }
        .action-btn {
            background: rgba(40, 60, 75, 0.95);
            border: none;
            border-bottom: 4px solid rgba(25,40,50,0.9);
            color: #fcf3dd;
            font-size: 1.2rem;
            font-weight: 600;
            padding: 8px 22px;
            border-radius: 50px;
            cursor: pointer;
            box-shadow: 0 5px 0 rgba(15,25,35,0.7);
            transition: 0.05s linear;
            text-transform: uppercase;
            border: 1px solid rgba(100,130,150,0.5);
        }
        .action-btn:active {
            transform: translateY(4px);
            border-bottom-width: 2px;
            box-shadow: 0 2px 0 #15222b;
        }
        .reset-score-btn {
            background: rgba(70, 60, 60, 0.95);
            border-bottom-color: rgba(40,35,35,0.9);
        }

        @media (max-width: 700px) {
            .board-row {
                flex-wrap: wrap;
            }
            .online-players {
                flex-direction: row;
                order: 2;
                margin-top: 10px;
            }
            #board {
                order: 1;
                width: 340px;
                height: 340px;
            }
            .game-container {
                max-width: 500px;
                padding: 15px;
            }
        }
        @media (max-width: 450px) {
            #board { width: 300px; height: 300px; }
            .led { width: 12px; height: 12px; }
            .turn-indicator { font-size: 0.8rem; padding: 3px 8px; }
            .score-box { font-size: 1rem; padding: 4px 12px; gap: 10px; }
            .mode-btn { font-size: 0.9rem; padding: 6px 14px; }
            .avatar { width: 40px; height: 40px; font-size: 0.9rem; }
            .dot { width: 10px; height: 10px; }
        }
    </style>
    <!-- jQuery, chess.js, chessboardjs -->
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/chess.js/0.10.3/chess.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/chessboard-js/1.0.0/chessboard-1.0.0.min.js"></script>
</head>
<body>
    <canvas id="particle-canvas"></canvas>

    <div class="game-container">
        <div class="header">
            <div class="score-box">
                <div class="score-item">‚ö™ <span id="scoreWhite" class="score-badge">0</span></div>
                <div class="score-item">‚ö´ <span id="scoreBlack" class="score-badge">0</span></div>
            </div>
            <div class="turn-indicators">
                <span id="white-turn" class="turn-indicator active">1. White</span>
                <span id="black-turn" class="turn-indicator">2. Black</span>
            </div>
            <div class="hamburger" id="hamburgerBtn">
                <div class="hamburger-line"></div>
                <div class="hamburger-line"></div>
                <div class="hamburger-line"></div>
            </div>
        </div>

        <div class="hamburger-dropdown" id="hamburgerDropdown">
            <button id="fixLagBtn">Fix Lag: Off</button>
        </div>

        <div class="mode-selector">
            <button id="mode2p" class="mode-btn">üë• 2P</button>
            <button id="modeBot" class="mode-btn">ü§ñ Bot</button>
            <button id="modeOnline" class="mode-btn active">üåê Online</button>
        </div>

        <div id="onlinePanel" class="online-panel">
            <div class="online-row">
                <input type="text" id="nameInput" class="online-input" placeholder="Nama kamu" value="Player">
                <input type="text" id="peerIdInput" class="online-input" placeholder="ID lawan">
            </div>
            <div class="online-row">
                <button id="hostBtn" class="online-btn">üéÆ Host</button>
                <button id="joinBtn" class="online-btn">üîó Join</button>
            </div>
            <div class="online-row">
                <span id="onlineStatus" class="online-status">Status: Offline</span>
                <span id="myPeerId" class="online-status"></span>
            </div>
        </div>

        <div class="board-wrapper">
            <div class="led-strip">
                <div class="led"></div><div class="led"></div><div class="led"></div><div class="led"></div>
                <div class="led"></div><div class="led"></div><div class="led"></div><div class="led"></div>
                <div class="led"></div><div class="led"></div><div class="led"></div><div class="led"></div>
            </div>

            <div class="board-row">
                <div class="online-players left">
                    <div class="avatar" id="avatarLeft1"><span>P1</span><span class="dot"></span></div>
                    <div class="avatar" id="avatarLeft2"><span>P2</span><span class="dot"></span></div>
                    <div class="avatar" id="avatarLeft3"><span>P3</span><span class="dot offline"></span></div>
                    <div class="avatar" id="avatarLeft4"><span>P4</span><span class="dot"></span></div>
                </div>

                <div id="board"></div>

                <div class="online-players right">
                    <div class="avatar" id="avatarRight1"><span>P5</span><span class="dot"></span></div>
                    <div class="avatar" id="avatarRight2"><span>P6</span><span class="dot"></span></div>
                    <div class="avatar" id="avatarRight3"><span>P7</span><span class="dot offline"></span></div>
                    <div class="avatar" id="avatarRight4"><span>P8</span><span class="dot"></span></div>
                </div>
            </div>

            <div class="led-strip">
                <div class="led"></div><div class="led"></div><div class="led"></div><div class="led"></div>
                <div class="led"></div><div class="led"></div><div class="led"></div><div class="led"></div>
                <div class="led"></div><div class="led"></div><div class="led"></div><div class="led"></div>
            </div>
        </div>

        <div class="footer">
            <button class="action-btn" id="newGameBtn">‚Ü∫ New</button>
            <button class="action-btn reset-score-btn" id="resetScoreBtn">‚ü≤ Reset</button>
        </div>
    </div>

    <script>
        // ==================== PARTIKEL RINGAN ====================
        const ParticleSystem = (function() {
            const canvas = document.getElementById('particle-canvas');
            const ctx = canvas.getContext('2d');
            let width, height;
            let particles = [];
            let animationFrame = null;
            let isRunning = false;

            function initParticles() {
                particles = [];
                const particleCount = 20; // turun dari 70
                for (let i = 0; i < particleCount; i++) {
                    particles.push({
                        x: Math.random() * width,
                        y: Math.random() * height,
                        vx: (Math.random() - 0.5) * 0.3,
                        vy: (Math.random() - 0.5) * 0.15,
                        radius: Math.random() * 2 + 1,
                        color: `hsl(${Math.random() * 60 + 200}, 70%, 65%)`,
                        alpha: Math.random() * 0.5 + 0.2,
                        blinkSpeed: Math.random() * 0.02 + 0.01,
                        blinkPhase: Math.random() * Math.PI * 2
                    });
                }
            }

            function resizeCanvas() {
                width = window.innerWidth;
                height = window.innerHeight;
                canvas.width = width;
                canvas.height = height;
                if (isRunning) drawParticles();
            }

            function updateParticles() {
                for (let p of particles) {
                    p.x += p.vx;
                    p.y += p.vy;
                    if (p.x < 0) p.x = width;
                    if (p.x > width) p.x = 0;
                    if (p.y < 0) p.y = height;
                    if (p.y > height) p.y = 0;
                    p.alpha = 0.3 + 0.3 * Math.sin(Date.now() * p.blinkSpeed + p.blinkPhase);
                }
            }

            function drawParticles() {
                ctx.clearRect(0, 0, width, height);
                for (let p of particles) {
                    ctx.beginPath();
                    ctx.arc(p.x, p.y, p.radius, 0, Math.PI * 2);
                    ctx.fillStyle = p.color;
                    ctx.globalAlpha = p.alpha;
                    ctx.fill();
                }
                ctx.globalAlpha = 1.0;
            }

            function animate() {
                if (!isRunning) return;
                updateParticles();
                drawParticles();
                animationFrame = requestAnimationFrame(animate);
            }

            function start() {
                if (isRunning) return;
                isRunning = true;
                if (!particles.length) initParticles();
                animate();
            }

            function stop() {
                isRunning = false;
                if (animationFrame) {
                    cancelAnimationFrame(animationFrame);
                    animationFrame = null;
                }
                ctx.clearRect(0, 0, width, height);
            }

            window.addEventListener('resize', resizeCanvas);
            resizeCanvas();
            initParticles();
            start();

            return { start, stop };
        })();

        // ==================== LOGIKA CATUR ====================
        $(document).ready(function() {
            var game = new Chess();
            var pieceTheme = 'https://chessboardjs.com/img/chesspieces/wikipedia/{piece}.png';
            var gameMode = 'online';
            var scoreWhite = 0, scoreBlack = 0;
            var $scoreWhite = $('#scoreWhite'), $scoreBlack = $('#scoreBlack');
            var board;

            var peer = null, conn = null, myId = null, isHost = false, onlineConnected = false;
            var $onlineStatus = $('#onlineStatus'), $myPeerId = $('#myPeerId');

            // Nama dan identitas
            var myName = '';
            var opponentName = '';

            var audioCtx = null;
            function playMoveSound() {
                try {
                    if (!audioCtx) audioCtx = new (window.AudioContext || window.webkitAudioContext)();
                    if (audioCtx.state === 'suspended') {
                        audioCtx.resume().then(() => createMoveSound(audioCtx));
                    } else createMoveSound(audioCtx);
                } catch (e) { console.warn("Audio error"); }
            }
            function createMoveSound(ctx) {
                var osc = ctx.createOscillator();
                var gainNode = ctx.createGain();
                osc.type = 'sine';
                osc.frequency.value = 600;
                gainNode.gain.value = 0.8;
                osc.connect(gainNode);
                gainNode.connect(ctx.destination);
                osc.start();
                osc.stop(ctx.currentTime + 0.06);
            }

            // Fungsi update nama di avatar
            function updateAvatar(hostName, joinName) {
                if (hostName) {
                    $('#avatarLeft1 span:first-child').text(hostName);
                }
                if (joinName) {
                    $('#avatarRight1 span:first-child').text(joinName);
                }
            }

            function setMode(mode) {
                gameMode = mode;
                $('#mode2p, #modeBot, #modeOnline').removeClass('active');
                if (mode === '2player') $('#mode2p').addClass('active');
                else if (mode === 'vsbot') $('#modeBot').addClass('active');
                else if (mode === 'online') $('#modeOnline').addClass('active');
                if (mode === 'online') $('#onlinePanel').show();
                else {
                    $('#onlinePanel').hide();
                    if (conn) conn.close();
                    if (peer) peer.destroy();
                    peer = null; conn = null; onlineConnected = false;
                    $onlineStatus.text('Status: Offline');
                    $myPeerId.text('');
                    // reset avatar
                    $('#avatarLeft1 span:first-child').text('P1');
                    $('#avatarRight1 span:first-child').text('P5');
                }
            }

            function updateScoreUI() { $scoreWhite.text(scoreWhite); $scoreBlack.text(scoreBlack); }
            function updateTurnIndicators() {
                if (game.game_over()) {
                    if (game.in_checkmate()) {
                        var winnerColor = game.turn() === 'w' ? 'black' : 'white';
                        if (winnerColor === 'white') scoreWhite++; else scoreBlack++;
                        updateScoreUI();
                        alert((winnerColor === 'white' ? 'Putih' : 'Hitam') + ' menang!');
                    } else alert('Seri!');
                    return;
                }
                var turn = game.turn();
                $('#white-turn').toggleClass('active', turn === 'w');
                $('#black-turn').toggleClass('active', turn === 'b');
            }

            function makeBotMove() {
                if (gameMode !== 'vsbot' || game.game_over() || game.turn() !== 'b') return;
                var moves = game.moves();
                if (moves.length) {
                    game.move(moves[Math.floor(Math.random() * moves.length)]);
                    board.position(game.fen());
                    playMoveSound();
                    updateTurnIndicators();
                }
            }

            function sendMove(move) {
                if (conn && conn.open) conn.send({ type: 'move', from: move.from, to: move.to, promotion: 'q' });
            }
            function applyRemoteMove(moveData) {
                var move = game.move({ from: moveData.from, to: moveData.to, promotion: moveData.promotion });
                if (move) { board.position(game.fen()); playMoveSound(); updateTurnIndicators(); }
            }

            var boardConfig = {
                draggable: true,
                position: 'start',
                pieceTheme: pieceTheme,
                onDragStart: function(source, piece, pos, orient) {
                    if (game.game_over()) return false;
                    if (gameMode === 'online') {
                        if (!onlineConnected) { alert('Belum terhubung'); return false; }
                        var turn = game.turn();
                        if (isHost && turn === 'w') return true;
                        if (!isHost && turn === 'b') return true;
                        return false;
                    } else if (gameMode === 'vsbot') {
                        return game.turn() === 'w' && piece.search(/^w/) !== -1;
                    } else if (gameMode === '2player') {
                        var turn = game.turn();
                        return (turn === 'w' && piece.search(/^w/) !== -1) || (turn === 'b' && piece.search(/^b/) !== -1);
                    }
                    return false;
                },
                onDrop: function(source, target) {
                    var move = game.move({ from: source, to: target, promotion: 'q' });
                    if (!move) { alert('Langkah tidak sah'); return 'snapback'; }
                    board.position(game.fen());
                    playMoveSound();
                    updateTurnIndicators();
                    if (gameMode === 'online' && conn && conn.open) sendMove(move);
                    if (gameMode === 'vsbot' && !game.game_over()) setTimeout(makeBotMove, 200);
                    return true;
                },
                onSnapEnd: function() { board.position(game.fen()); }
            };

            board = Chessboard('board', boardConfig);
            updateTurnIndicators();
            updateScoreUI();

            $('#mode2p').click(() => setMode('2player'));
            $('#modeBot').click(() => setMode('vsbot'));
            $('#modeOnline').click(() => setMode('online'));

            $('#hostBtn').click(() => {
                myName = $('#nameInput').val().trim();
                if (!myName) myName = 'Host';
                if (peer) peer.destroy();
                peer = new Peer();
                peer.on('open', id => {
                    myId = id; isHost = true; onlineConnected = false;
                    $onlineStatus.text('Status: Menunggu lawan...');
                    $myPeerId.text('ID: ' + id);
                });
                peer.on('connection', c => {
                    conn = c;
                    conn.on('open', () => {
                        onlineConnected = true;
                        // Kirim nama kita ke lawan
                        conn.send({ type: 'name', name: myName });
                        $onlineStatus.text('Status: Terhubung (Putih)');
                        game.reset(); board.position(game.fen()); updateTurnIndicators();
                        // Update avatar kiri dengan nama kita
                        $('#avatarLeft1 span:first-child').text(myName);
                    });
                    conn.on('data', d => {
                        if (d.type === 'move') applyRemoteMove(d);
                        else if (d.type === 'name') {
                            opponentName = d.name;
                            $('#avatarRight1 span:first-child').text(opponentName);
                        }
                    });
                    conn.on('close', () => { onlineConnected = false; $onlineStatus.text('Status: Putus'); });
                });
            });

            $('#joinBtn').click(() => {
                myName = $('#nameInput').val().trim();
                if (!myName) myName = 'Player';
                var targetId = $('#peerIdInput').val().trim();
                if (!targetId) { alert('Masukkan ID lawan'); return; }
                if (peer) peer.destroy();
                peer = new Peer();
                peer.on('open', id => {
                    myId = id; isHost = false;
                    $myPeerId.text('ID: ' + id);
                    conn = peer.connect(targetId);
                    conn.on('open', () => {
                        onlineConnected = true;
                        // Kirim nama kita ke lawan
                        conn.send({ type: 'name', name: myName });
                        $onlineStatus.text('Status: Terhubung (Hitam)');
                        game.reset(); board.position(game.fen()); updateTurnIndicators();
                        // Update avatar kanan dengan nama kita
                        $('#avatarRight1 span:first-child').text(myName);
                    });
                    conn.on('data', d => {
                        if (d.type === 'move') applyRemoteMove(d);
                        else if (d.type === 'name') {
                            opponentName = d.name;
                            $('#avatarLeft1 span:first-child').text(opponentName);
                        }
                    });
                    conn.on('close', () => { onlineConnected = false; $onlineStatus.text('Status: Putus'); });
                });
            });

            $('#newGameBtn').click(() => { game.reset(); board.position(game.fen()); updateTurnIndicators(); });
            $('#resetScoreBtn').click(() => { scoreWhite = 0; scoreBlack = 0; updateScoreUI(); });

            setMode('online');

            // Hamburger & Fix Lag
            let lagFixActive = false;
            $('#hamburgerBtn').click(e => { e.stopPropagation(); $('#hamburgerDropdown').toggleClass('show'); });
            $(document).click(() => $('#hamburgerDropdown').removeClass('show'));
            $('#hamburgerDropdown').click(e => e.stopPropagation());
            $('#fixLagBtn').click(function() {
                lagFixActive = !lagFixActive;
                if (lagFixActive) { ParticleSystem.stop(); $(this).text('Fix Lag: On'); }
                else { ParticleSystem.start(); $(this).text('Fix Lag: Off'); }
                $('#hamburgerDropdown').removeClass('show');
            });
        });
    </script>
</body>
</html>
